(function(){"use strict";const CONFIG={filterMode:"OR",animationDuration:300,debounceDelay:150};let state={selectedCategories:[],allMarkers:[],map:null,markersLayer:null};function init(){console.log("[FILTER DEBUG] init() chiamato");const filterContainer=document.getElementById("risviel-map-filters");if(!filterContainer){console.log("[FILTER DEBUG] filterContainer non trovato, esco");return}if(!window.risvielMap||!window.risvielMap.markersLayer){console.log("[FILTER DEBUG] risvielMap non pronto, ritento tra 200ms",{risvielMap:window.risvielMap,markersLayer:window.risvielMap?.markersLayer});setTimeout(init,200);return}console.log("[FILTER DEBUG] Inizializzazione completata",{markersLayer:window.risvielMap.markersLayer,markersCount:window.risvielMap.markers?.length});filterContainer.addEventListener("change",handleFilterChange);filterContainer.addEventListener("touchend",handleTouchEnd,{passive:false});const checkedBoxes=filterContainer.querySelectorAll('input[type="checkbox"]:checked');state.selectedCategories=Array.from(checkedBoxes).map(cb=>cb.value);console.log("[FILTER DEBUG] Categorie inizialmente selezionate:",state.selectedCategories);state.map=window.risvielMap.map;state.markersLayer=window.risvielMap.markersLayer;state.allMarkers=window.risvielMap.markers||[]}function handleFilterChange(event){if(event.target.type!=="checkbox")return;const categoryId=event.target.value;const isChecked=event.target.checked;if(isChecked){if(!state.selectedCategories.includes(categoryId)){state.selectedCategories.push(categoryId)}}else{state.selectedCategories=state.selectedCategories.filter(id=>id!==categoryId)}updateCheckboxUI(event.target);debounce(applyFilter,CONFIG.debounceDelay)()}function handleTouchEnd(event){const label=event.target.closest(".risviel-filter-item");if(!label)return;event.preventDefault();const checkbox=label.querySelector('input[type="checkbox"]');if(checkbox){checkbox.checked=!checkbox.checked;checkbox.dispatchEvent(new Event("change",{bubbles:true}))}}function updateCheckboxUI(checkbox){const label=checkbox.closest(".risviel-filter-item");if(!label)return;if(checkbox.checked){label.classList.add("is-active");label.setAttribute("aria-pressed","true")}else{label.classList.remove("is-active");label.setAttribute("aria-pressed","false")}}function applyFilter(){if(window.risvielMap){if(window.risvielMap.markersLayer){state.markersLayer=window.risvielMap.markersLayer}if(window.risvielMap.markers){state.allMarkers=window.risvielMap.markers}}if(!state.markersLayer){console.warn("Markers layer not available");return}if(!state.allMarkers||!state.allMarkers.length){return}const showAll=state.selectedCategories.length===0;state.allMarkers.forEach(markerData=>{const marker=markerData.marker;const markerCategories=markerData.categories||[];let shouldShow=showAll;if(!showAll){shouldShow=markerCategories.some(catId=>state.selectedCategories.includes(String(catId)))}markerData.visible=shouldShow;if(shouldShow){showMarker(marker)}else{hideMarker(marker)}});document.dispatchEvent(new CustomEvent("risviel:filterApplied",{detail:{selectedCategories:state.selectedCategories,visibleCount:state.allMarkers.filter(m=>m.visible).length}}))}function showMarker(marker){const wasOnLayer=state.markersLayer.hasLayer(marker);if(!state.markersLayer.hasLayer(marker)){state.markersLayer.addLayer(marker)}console.log("[FILTER DEBUG] showMarker:",{wasOnLayer:wasOnLayer,nowOnLayer:state.markersLayer.hasLayer(marker),hasIcon:!!marker._icon});if(marker._icon){marker._icon.style.transition=`opacity ${CONFIG.animationDuration}ms ease`;marker._icon.style.opacity="1";marker._icon.style.pointerEvents="auto"}}function hideMarker(marker){console.log("[FILTER DEBUG] hideMarker:",{hasIcon:!!marker._icon,isOnLayer:state.markersLayer.hasLayer(marker)});if(marker._icon){marker._icon.style.transition=`opacity ${CONFIG.animationDuration}ms ease`;marker._icon.style.opacity="0";marker._icon.style.pointerEvents="none";setTimeout(()=>{if(marker._icon&&marker._icon.style.opacity==="0"){state.markersLayer.removeLayer(marker)}},CONFIG.animationDuration)}}function resetFilters(){const filterContainer=document.getElementById("risviel-map-filters");if(!filterContainer)return;const checkboxes=filterContainer.querySelectorAll('input[type="checkbox"]');checkboxes.forEach(cb=>{cb.checked=false;updateCheckboxUI(cb)});state.selectedCategories=[];applyFilter()}function selectAllCategories(){const filterContainer=document.getElementById("risviel-map-filters");if(!filterContainer)return;const checkboxes=filterContainer.querySelectorAll('input[type="checkbox"]');checkboxes.forEach(cb=>{cb.checked=true;updateCheckboxUI(cb);if(!state.selectedCategories.includes(cb.value)){state.selectedCategories.push(cb.value)}});applyFilter()}function debounce(func,wait){let timeout;return function executedFunction(...args){const later=()=>{clearTimeout(timeout);func(...args)};clearTimeout(timeout);timeout=setTimeout(later,wait)}}window.risvielFilter={init:init,applyFilter:applyFilter,resetFilters:resetFilters,selectAllCategories:selectAllCategories,getSelectedCategories:()=>[...state.selectedCategories],setSelectedCategories:categories=>{state.selectedCategories=categories;applyFilter()}};if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",init)}else{init()}})();