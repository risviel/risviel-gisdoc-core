(function($){"use strict";const controlsConfig={inertia:true,inertiaFriction:.95,minVelocity:.001,rotationSpeed:.002*.5,zoomSpeed:.5,minFOV:30,maxFOV:90,pinchDebounceDelay:300,debug:false};const activeControls=new Map;let isControlsInitialized=false;let touchStartTime=0;let touchStartPosition={x:0,y:0};let isTouchMoving=false;let touchTarget=null;$(document).ready(function(){setTimeout(initializeControls,1e3)});function initializeControls(){if(isControlsInitialized)return;if(window.panoramaViewers){for(const id in window.panoramaViewers){attachControlsToViewer(window.panoramaViewers[id],id)}}monitorViewerCreation();isControlsInitialized=true;if(controlsConfig.debug){console.log("ðŸŽ® Sistema di controlli avanzati inizializzato!")}}function monitorViewerCreation(){let knownViewers=new Set;const checkForNewViewers=()=>{if(window.panoramaViewers){for(const id in window.panoramaViewers){if(!knownViewers.has(id)&&window.panoramaViewers[id].camera){knownViewers.add(id);attachControlsToViewer(window.panoramaViewers[id],id)}}}setTimeout(checkForNewViewers,2e3)};checkForNewViewers()}function attachControlsToViewer(viewer,id){if(!viewer||!viewer.camera||!viewer.renderer){if(controlsConfig.debug){console.log(`ðŸŽ® Viewer ${id} non ancora pronto per i controlli, riproverÃ² piÃ¹ tardi`)}setTimeout(()=>attachControlsToViewer(viewer,id),500);return}if(activeControls.has(id)){return}setupAdvancedControls(viewer,id);if(controlsConfig.debug){console.log(`ðŸŽ® Controlli avanzati attaccati a viewer ${id}`)}}function setupAdvancedControls(viewer,viewerId){const state={isInteracting:false,previousPosition:{x:0,y:0},phi:0,theta:0,velocity:{x:0,y:0},lastMoveTime:0,inertiaActive:false,isPinching:false,initialPinchDistance:0,initialFOV:0,lastPinchDistance:0,pinchEndTime:0,animationFrameId:null};activeControls.set(viewerId,state);const element=viewer.renderer.domElement;element.style.cursor="grab";function getEventPosition(event){if(event.touches&&event.touches.length>0){return{x:event.touches[0].clientX,y:event.touches[0].clientY}}else{return{x:event.clientX,y:event.clientY}}}function getPinchDistance(event){if(event.touches.length<2)return 0;const touch1=event.touches[0];const touch2=event.touches[1];return Math.sqrt(Math.pow(touch2.clientX-touch1.clientX,2)+Math.pow(touch2.clientY-touch1.clientY,2))}function isInPinchDebounce(){return Date.now()-state.pinchEndTime<controlsConfig.pinchDebounceDelay}function startInteraction(event){if(event.touches&&event.touches.length===2){event.preventDefault();state.isPinching=true;state.isInteracting=false;state.inertiaActive=false;state.initialPinchDistance=getPinchDistance(event);state.lastPinchDistance=state.initialPinchDistance;state.initialFOV=viewer.camera.fov;return}if(event.touches&&event.touches.length>1)return;if(event.touches&&isInPinchDebounce()){event.preventDefault();return}if(!event.touches){event.preventDefault();state.isInteracting=true;state.isPinching=false;state.inertiaActive=false;state.velocity={x:0,y:0};const position=getEventPosition(event);state.previousPosition=position;state.lastMoveTime=Date.now();element.style.cursor="grabbing";return}const position=getEventPosition(event);isTouchMoving=false;touchStartTime=Date.now();touchStartPosition={x:position.x,y:position.y};touchTarget=event.target;state.previousPosition=position;state.lastMoveTime=Date.now();state.velocity={x:0,y:0}}function moveInteraction(event){if(state.isPinching&&event.touches&&event.touches.length===2){event.preventDefault();const currentPinchDistance=getPinchDistance(event);if(state.initialPinchDistance>0&&currentPinchDistance>0){const pinchDelta=currentPinchDistance-state.lastPinchDistance;viewer.camera.fov-=pinchDelta*controlsConfig.zoomSpeed;viewer.camera.fov=Math.max(controlsConfig.minFOV,Math.min(controlsConfig.maxFOV,viewer.camera.fov));viewer.camera.updateProjectionMatrix();state.lastPinchDistance=currentPinchDistance}return}if(!event.touches&&state.isInteracting&&!state.isPinching){event.preventDefault();const currentTime=Date.now();const currentPosition=getEventPosition(event);const deltaMove={x:currentPosition.x-state.previousPosition.x,y:currentPosition.y-state.previousPosition.y};const deltaTime=currentTime-state.lastMoveTime;if(deltaTime>0){state.velocity.x=deltaMove.x/deltaTime;state.velocity.y=deltaMove.y/deltaTime}state.theta-=deltaMove.x*controlsConfig.rotationSpeed;state.phi-=deltaMove.y*controlsConfig.rotationSpeed;state.phi=Math.max(-Math.PI/2+.01,Math.min(Math.PI/2-.01,state.phi));updateCameraRotation(viewer,state.phi,state.theta);updateIndicatorsOrientation(viewer);state.previousPosition=currentPosition;state.lastMoveTime=currentTime;return}if(event.touches&&event.touches.length===1&&!state.isPinching){if(isInPinchDebounce()){return}const currentPosition=getEventPosition(event);const moveDistance=Math.sqrt(Math.pow(currentPosition.x-touchStartPosition.x,2)+Math.pow(currentPosition.y-touchStartPosition.y,2));if(moveDistance>15){event.preventDefault();if(!isTouchMoving){isTouchMoving=true;state.isInteracting=true;state.inertiaActive=false}const currentTime=Date.now();const deltaMove={x:currentPosition.x-state.previousPosition.x,y:currentPosition.y-state.previousPosition.y};const deltaTime=currentTime-state.lastMoveTime;if(deltaTime>0){state.velocity.x=deltaMove.x/deltaTime;state.velocity.y=deltaMove.y/deltaTime}state.theta-=deltaMove.x*controlsConfig.rotationSpeed;state.phi-=deltaMove.y*controlsConfig.rotationSpeed;state.phi=Math.max(-Math.PI/2+.01,Math.min(Math.PI/2-.01,state.phi));updateCameraRotation(viewer,state.phi,state.theta);updateIndicatorsOrientation(viewer);state.previousPosition=currentPosition;state.lastMoveTime=currentTime}}}function endInteraction(event){if(state.isPinching){state.isPinching=false;state.initialPinchDistance=0;state.lastPinchDistance=0;state.pinchEndTime=Date.now();return}if(event.changedTouches&&!isTouchMoving){const touchDuration=Date.now()-touchStartTime;if(touchDuration<500){if(controlsConfig.debug){console.log("ðŸ–±ï¸ Touch tap rilevato, lasciando che il browser gestisca il click naturale")}}}if(state.isInteracting){try{if(event.preventDefault&&!event.defaultPrevented){event.preventDefault()}}catch(e){}state.isInteracting=false;element.style.cursor="grab";if(controlsConfig.inertia&&!isInPinchDebounce()){const velocityMagnitude=Math.sqrt(state.velocity.x*state.velocity.x+state.velocity.y*state.velocity.y);if(velocityMagnitude>controlsConfig.minVelocity){state.inertiaActive=true;applyInertia()}}}isTouchMoving=false;touchTarget=null}function updateCameraRotation(viewer,phi,theta){const quaternion=new THREE.Quaternion;const xQuaternion=new THREE.Quaternion;xQuaternion.setFromAxisAngle(new THREE.Vector3(-1,0,0),phi);const yQuaternion=new THREE.Quaternion;yQuaternion.setFromAxisAngle(new THREE.Vector3(0,-1,0),theta);quaternion.multiplyQuaternions(yQuaternion,xQuaternion);viewer.camera.quaternion.copy(quaternion)}function updateIndicatorsOrientation(viewer){if(typeof window.updateIndicatorsOrientation==="function"){window.updateIndicatorsOrientation(viewer)}else if(viewer.activeIndicators&&viewer.activeIndicators.length){viewer.activeIndicators.forEach(indicator=>{if(indicator.mesh){indicator.mesh.quaternion.copy(viewer.camera.quaternion)}})}}function applyInertia(){if(!state.inertiaActive)return;state.velocity.x*=controlsConfig.inertiaFriction;state.velocity.y*=controlsConfig.inertiaFriction;const deltaTime=16;const deltaX=state.velocity.x*deltaTime;const deltaY=state.velocity.y*deltaTime;state.theta-=deltaX*controlsConfig.rotationSpeed;state.phi-=deltaY*controlsConfig.rotationSpeed;state.phi=Math.max(-Math.PI/2+.01,Math.min(Math.PI/2-.01,state.phi));updateCameraRotation(viewer,state.phi,state.theta);updateIndicatorsOrientation(viewer);const velocityMagnitude=Math.sqrt(state.velocity.x*state.velocity.x+state.velocity.y*state.velocity.y);if(velocityMagnitude>controlsConfig.minVelocity){state.animationFrameId=requestAnimationFrame(applyInertia)}else{state.inertiaActive=false;state.animationFrameId=null}}element.addEventListener("mousedown",startInteraction);document.addEventListener("mousemove",moveInteraction);document.addEventListener("mouseup",endInteraction);element.addEventListener("click",function(event){if(!event.touches&&typeof window.handleInteraction==="function"){window.handleInteraction(viewer,event,"mouse")}});element.addEventListener("touchstart",startInteraction,{passive:true});element.addEventListener("touchmove",moveInteraction,{passive:false});element.addEventListener("touchend",endInteraction,{passive:true});element.addEventListener("wheel",function(event){event.preventDefault();const delta=event.deltaY;viewer.camera.fov+=delta*.05;viewer.camera.fov=Math.max(controlsConfig.minFOV,Math.min(controlsConfig.maxFOV,viewer.camera.fov));viewer.camera.updateProjectionMatrix()});if(viewer.camera){const euler=(new THREE.Euler).setFromQuaternion(viewer.camera.quaternion,"YXZ");state.phi=euler.x;state.theta=euler.y}if(controlsConfig.debug){console.log(`ðŸŽ® Controlli avanzati configurati per ${viewerId}`)}}window.controlsConfig=controlsConfig;window.advancedControls={getActiveViewers:function(){return Array.from(activeControls.keys())},setInertia:function(enabled,friction=.95){controlsConfig.inertia=enabled;if(friction!==undefined){controlsConfig.inertiaFriction=Math.max(.8,Math.min(.99,friction))}},setRotationSpeed:function(speed){controlsConfig.rotationSpeed=Math.max(1e-4,Math.min(.01,speed))},setZoomSpeed:function(speed){controlsConfig.zoomSpeed=Math.max(.1,Math.min(2,speed))},setFOVLimits:function(min,max){controlsConfig.minFOV=Math.max(10,Math.min(45,min));controlsConfig.maxFOV=Math.max(60,Math.min(120,max))},debug:function(){controlsConfig.debug=!controlsConfig.debug;console.log("ðŸ”§ Debug mode:",controlsConfig.debug?"ON":"OFF");console.log("ðŸ“Š Configurazione corrente:",controlsConfig);console.log("ðŸ“Š Controlli attivi:",Array.from(activeControls.keys()))},reinitialize:function(){activeControls.forEach((state,viewerId)=>{if(state.animationFrameId){cancelAnimationFrame(state.animationFrameId)}});activeControls.clear();isControlsInitialized=false;setTimeout(initializeControls,100)},getControlState:function(viewerId){if(!activeControls.has(viewerId)){console.warn(`Controllo per ${viewerId} non trovato`);return null}return{...activeControls.get(viewerId)}},setRotation:function(viewerId,phi,theta){if(!activeControls.has(viewerId)||!window.panoramaViewers[viewerId]){console.warn(`Viewer ${viewerId} non trovato`);return}const state=activeControls.get(viewerId);const viewer=window.panoramaViewers[viewerId];phi=Math.max(-Math.PI/2+.01,Math.min(Math.PI/2-.01,phi));state.phi=phi;state.theta=theta;state.velocity={x:0,y:0};state.inertiaActive=false;const quaternion=new THREE.Quaternion;const xQuaternion=new THREE.Quaternion;xQuaternion.setFromAxisAngle(new THREE.Vector3(-1,0,0),phi);const yQuaternion=new THREE.Quaternion;yQuaternion.setFromAxisAngle(new THREE.Vector3(0,-1,0),theta);quaternion.multiplyQuaternions(yQuaternion,xQuaternion);viewer.camera.quaternion.copy(quaternion);if(typeof window.updateIndicatorsOrientation==="function"){window.updateIndicatorsOrientation(viewer)}}};window.setupAdvancedControls=setupAdvancedControls})(jQuery);